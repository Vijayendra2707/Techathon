<!DOCTYPE html>
<html>
<head>
<title>SafePath AI Dashboard</title>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<link rel="stylesheet"
 href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body{font-family:Arial;background:#f4f6f9;margin:20px}
.card{display:inline-block;background:white;padding:20px;margin:10px;
border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
.chart{width:48%;display:inline-block;}
#map{height:500px;margin-top:20px;}
</style>
</head>

<body>

<button onclick="useLiveLocation()">
üìç Use My Live Location
</button>

<hr>
<h2>üß≠ Safe Route Planner</h2>

Destination:
<input id="destination"
       placeholder="FC Road Pune">

<button onclick="findRoute()">Find Route</button>
<div id="map"></div>

</body>
<script>

// MAP
const map=L.map('map').setView([18.5204,73.8567],13);
L.tileLayer(
'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
).addTo(map);

let layers=[];

let userLocation = null;

// --------------------
// GET LIVE LOCATION
// --------------------
function useLiveLocation(){

if(!navigator.geolocation){
    alert("Geolocation not supported");
    return;
}

navigator.geolocation.getCurrentPosition(
    (position)=>{

        userLocation = {
            lat: position.coords.latitude,
            lon: position.coords.longitude
        };

        // move map to user
        map.setView([userLocation.lat, userLocation.lon], 14);

        // marker
        L.marker([userLocation.lat, userLocation.lon])
            .addTo(map)
            .bindPopup("You are here")
            .openPopup();

    },
    ()=>{
        alert("Location permission denied");
    }
);
}

// --------------------
// ROUTE LEGEND
// --------------------
const legend = L.control({ position: "bottomright" });

legend.onAdd = function () {

    const div = L.DomUtil.create("div", "info legend");

    div.innerHTML = `
        <h4>Route Legend</h4>

        <div style="display:flex;align-items:center;margin-bottom:5px">
            <span style="
                width:20px;
                height:4px;
                background:blue;
                display:inline-block;
                margin-right:8px;">
            </span>
            Fastest Route
        </div>

        <div style="display:flex;align-items:center">
            <span style="
                width:20px;
                height:4px;
                background:green;
                display:inline-block;
                margin-right:8px;">
            </span>
            Safest Route
        </div>
    `;

    return div;
};

legend.addTo(map);

async function findRoute(){

if(!userLocation){
    alert("Click 'Use My Live Location' first");
    return;
}

const destination =
    document.getElementById("destination").value;

const res = await fetch("/routes",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
destination: destination,
start_lat: userLocation.lat,
start_lon: userLocation.lon
})
});

const data = await res.json();

layers.forEach(l=>map.removeLayer(l));
layers=[];

data.routes.forEach(route=>{

let coords = route.points.map(p=>[p[0],p[1]]);
let color="gray";

if(route.type==="fastest") color="blue";
if(route.type==="safest") color="green";

let poly=L.polyline(coords,{
color:color,
weight:6
}).addTo(map);

layers.push(poly);

});
}</script>

</body>
</html>