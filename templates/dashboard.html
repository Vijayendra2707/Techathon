<!DOCTYPE html>
<html>
<head>
<title>SafePath AI Dashboard</title>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<link rel="stylesheet"
 href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body{font-family:Arial;background:#f4f6f9;margin:20px}
.card{display:inline-block;background:white;padding:20px;margin:10px;
border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
.chart{width:48%;display:inline-block;}
#map{height:500px;margin-top:20px;}
</style>
</head>

<body>

<h1>ğŸš¦ SafePath AI â€” Risk Analytics Dashboard</h1>

<div class="card"><h3>Average Risk Score</h3>
<h2>{{metrics.avg_risk_score}}</h2></div>

<div class="card"><h3>Average Prediction</h3>
<h2>{{metrics.avg_prediction}}</h2></div>

<div class="card"><h3>High Risk Locations</h3>
<h2>{{metrics.high_risk_count}}</h2></div>

<div class="card"><h3>Total Accidents</h3>
<h2>{{metrics.total_accidents}}</h2></div>

<div id="dayChart" class="chart"></div>
<div id="riskChart" class="chart"></div>
<div id="roadChart" style="width:98%"></div>

<button onclick="useLiveLocation()">
ğŸ“ Use My Live Location
</button>

<hr>
<h2>ğŸ§­ Safe Route Planner</h2>

Destination:
<input id="destination"
       placeholder="FC Road Pune">

<button onclick="findRoute()">Find Route</button>
<div id="map"></div>

<script>
let dayData={{day_counts|tojson}};
Plotly.newPlot("dayChart",[{
x:Object.keys(dayData),
y:Object.values(dayData),
type:"bar"}]);

let riskData={{risk_bins|tojson}};
Plotly.newPlot("riskChart",[{
labels:Object.keys(riskData),
values:Object.values(riskData),
type:"pie"}]);

let roadData={{road_risk|tojson}};
Plotly.newPlot("roadChart",[{
x:Object.keys(roadData),
y:Object.values(roadData),
type:"bar"}]);

// MAP
const map=L.map('map').setView([18.5204,73.8567],13);
L.tileLayer(
'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
).addTo(map);

let layers=[];

let userLocation = null;

// --------------------
// GET LIVE LOCATION
// --------------------
function useLiveLocation(){

if(!navigator.geolocation){
    alert("Geolocation not supported");
    return;
}

navigator.geolocation.getCurrentPosition(
    (position)=>{

        userLocation = {
            lat: position.coords.latitude,
            lon: position.coords.longitude
        };

        // move map to user
        map.setView([userLocation.lat, userLocation.lon], 14);

        // marker
        L.marker([userLocation.lat, userLocation.lon])
            .addTo(map)
            .bindPopup("You are here")
            .openPopup();

    },
    ()=>{
        alert("Location permission denied");
    }
);
}

async function findRoute(){

if(!userLocation){
    alert("Click 'Use My Live Location' first");
    return;
}

const destination =
    document.getElementById("destination").value;

const res = await fetch("/routes",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
destination: destination,
start_lat: userLocation.lat,
start_lon: userLocation.lon
})
});

const data = await res.json();

layers.forEach(l=>map.removeLayer(l));
layers=[];

data.routes.forEach(route=>{

let coords = route.points.map(p=>[p[0],p[1]]);
let color="gray";

if(route.type==="fastest") color="blue";
if(route.type==="safest") color="green";

let poly=L.polyline(coords,{
color:color,
weight:6
}).addTo(map);

layers.push(poly);

});
}</script>

</body>
</html>